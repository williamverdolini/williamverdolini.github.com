<!-- Markup JSON-LD generato da Assistente per il markup dei dati strutturati di Google. -->
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Article",
  "name" : "Cross-Origin Resource Sharing (CORS)",
  "author" : {
    "@type" : "Person",
    "name" : "William Verdolini"
  },
  "datePublished" : "2014-03-28",
  "articleSection" : [ "CORS", "WebApi"  ],
  "url" : "http://williamverdolini.github.io/2014/03/28/discitur-CORS"
}
</script>

<p><em>cos’è il <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank">Cross-Origin Resource Sharing</a></em>? un
meccanismo che consente ad una applicazione web di accedere a risorse di un
altro dominio.</p>

<p> </p>

<p><em>Perché serve</em>? per una serie di motivi tutti molto validi ed
attuali:</p>

<ol>
  <li>perché con l’uso intensivo di librerie
  javascript che fanno chiamate AJAX e l’esplosione di social network che
  consentono di accedere alle proprie risorse, le applicazioni web sono
  diventate vere e proprie “rich client application”, in grado di richiamare
  un’elevata serie di funzionalità e dati da fonti esterne</li>
  <li>per questioni di sicurezza. Infatti tutti i
  browser implementano una policy che impedisce alle applicazioni web di
  accedere a risorse esterne se non rispettando determinate caratteristiche
  (<a href="http://en.wikipedia.org/wiki/Same_origin_policy" target="_blank">same-origin policy</a>).</li>
</ol>

<p> </p>

<p><em>Perché ne parlo</em>? perché mi è servito per realizzare un ambiente
di User Acceptance Test completamente gratuito! (venale, ma è la verità).
Scherzi a parte, mi ero prefissato l’obiettivo di rimanere low-cost e dopo un
po’ è diventato quasi una sfida personale. Infatti nel mondo .NET non sono
molti i provider che consentono di avere server senza costi di attivazione o
canoni (su questo fronte i colleghi del PHP hanno una vita più facile).</p>

<p>Quello che ho trovato io è <a href="https://somee.com/default.aspx" target="_blank">Somee.com</a>:
per ambienti piccoli o di test mette a disposizione Server Windows 2012 (ad
oggi) con SQL Server senza dover sostenere alcun costo. L’interfaccia di
gestione è un po’ spartana, ma con il solito accesso FTP alla fine si riesce a
fare quello che serve.</p>

<p>Bello! Se non fosse che Somee.com impone di visualizzare sulle pagine HTML
restituite dai loro server gratuiti un po’ 
di pubblicità. Non sono contrario a questo baratto (a caval donato non
si guarda in bocca). Il problema sta nel modo in cui inseriscono questa
pubblicità…infatti hanno fatto in modo che ogni risorsa html richiesta al
server venga restituita con il seguente suffisso:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--SCRIPT GENERATED BY SERVER! PLEASE REMOVE--&gt;</span>
<span class="nt">&lt;center&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://somee.com"</span><span class="nt">&gt;</span>Web hosting by Somee.com<span class="nt">&lt;/a&gt;&lt;/center&gt;</span>
<span class="nt">&lt;/textarea&gt;&lt;/xml&gt;&lt;</span> <span class="err">/</span><span class="na">script</span><span class="nt">&gt;&lt;/noframes&gt;&lt;/noscript&gt;&lt;/object&gt;&lt;/layer&gt;&lt;/style&gt;&lt;/title&gt;&lt;/applet&gt;</span>
<span class="nt">&lt;script </span><span class="na">language=</span><span class="s">"JavaScript"</span> <span class="na">src=</span><span class="s">"http://ads.mgmt.somee.com/serveimages/ad2/WholeInsert4.js"</span><span class="nt">&gt;&lt; /script&gt;</span>
<span class="c">&lt;!--SCRIPT GENERATED BY SERVER! PLEASE REMOVE--&gt;</span>
</code></pre></div></div>

<p>questo “giochino” ha lo spiacevole effetto di spaccare completamente la mia
applicazione angular.js!!!</p>

<p>Infatti tutte le direttive richiedono che il proprio template abbia un
root-node unico…cosa che, con somee.com, non è più vera…</p>

<p>Non mi sono rassegnato alla cosa (anche perché, da newbie, deployare per la
prima volta l’applicazione su questi server, mi è costato diverse ore) ed ho
ripensato a quanto accennato in un <a href="http://williamverdolini.github.io/2014/01/24/discitur-separation/" target="_blank">precedente articolo</a>, ovvero che, grazie all’organizzazione dei servizi e all’uso di
una baseUrl unica, è molto semplice indicare ad Angular quale server puntare
per le chiamate RESTful. BENE!</p>

<p>Grazie a <a href="https://github.com/" target="_blank">Github</a> (che non finirò mai di
ringraziare!) chiunque si registri ha a disposizione (gratuitamente) uno spazio
web per la pubblicazione del proprio materiale: <a href="http://pages.github.com/" target="_blank">Github Pages</a>, che è, per l’appunto, lo
spazio in cui pubblico questi articoli. A questo punto credo di aver tutto e
potrei realizzare il mio ambiente di UAT con questo Environment Management:</p>

<p><img src="/images/discitur/UAT_env.png" /> </p>

<p>Ogni Client quindi interroga il server Github per le risorse statiche (.html, .js, .css, ecc.) ed il
server Somee per le risorse dinamiche (i servizi).
In questo scenario, il client deve poter fare chiamate CORS e le
web api devono essere configurate per consentire l’accesso dall’esterno.
Considerando questo scenario, vorrei anche prevedere che l’origine autorizzata
sia configurabile e annullabile (perché in produzione avrei origini differenti
o potrei non avere affatto bisogno di questo scenario).</p>

<p> </p>

<p>Per far questo i passaggi sono stati semplici:</p>

<ol>
  <li>installazione della libreria Microsoft.Owin.Cors</li>
  <li>Creazione di una <a href="https://github.com/williamverdolini/discitur-api/blob/sprint5/Web.config#L29" target="_blank">sezione applicativa di configurazione del CORS</a></li>
  <li>Creazione di una <a href="https://github.com/williamverdolini/discitur-api/blob/sprint5/App_Start/Startup.Auth.cs#L107" target="_blank">classe di CORS Policy custom</a> (con l’origine da abilitare)</li>
  <li><a href="https://github.com/williamverdolini/discitur-api/blob/sprint5/App_Start/Startup.Auth.cs#L67" target="_blank">Impostazione della policy CORS</a> in funzione dei dati in configurazione</li>
</ol>

<p>Funziona. Ed è gratis!
 </p>

<p><strong>Preflighted requests</strong></p>

<p>Interessante è stato vedere all’opera le preflighted requests, che sono uno
dei comportamenti della policy CORS che i browser applicano. Consiste nel fatto
che il browser, a fronte di caratteristiche particolari (ad es. per la presenza
di header custom), sempre per garantire la sicurezza, prima di eseguire una
richiesta http Cross-Origin, “bussa” al server con una richiesta light, con
header di base e method OPTIONS, per assicurarsi che questa chiamata sia
riconoscibile dal server.</p>

<p>Nell’ambiente di UAT di Discitur, è molto evidente questo comportamento,
infatti, a seguito dell’autenticazione, grazie all’uso degli interceptor
Angular.js si inserisce un header custom con il token di autenticazione. Questo
ulteriore token mette in allerta il browser, che avvia il meccanismo delle
preflighted requests</p>

<p>Se si verifica il traffico dell’applicazione, si può vedere che prima
dell’autenticazione si hanno simple requests:</p>

<p><img src="/images/discitur/preflighted.png" /></p>

<p>con abilitazione al CORS</p>

<p><img src="/images/discitur/preflighted2.png" /></p>

<p>dopo l’autenticazione, con il token nell’head, il browser lancia le preflight requests:</p>

<p><img src="/images/discitur/preflighted3.png" /></p>

<p>ognuna delle quali “bussa” al server richiedendo l’autorizzazione alla chiamata reale:</p>

<p><img src="/images/discitur/preflighted4.png" /></p>

<p>Articoli indispensabili sul tema sono: <br />
<a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS" target="_blank">https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS</a><br />
<a href="http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api" target="_blank">http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api</a>
 </p>
