<!-- Markup JSON-LD generato da Assistente per il markup dei dati strutturati di Google. -->
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Article",
  "name" : "Cross-Origin Resource Sharing (CORS)",
  "author" : {
    "@type" : "Person",
    "name" : "William Verdolini"
  },
  "datePublished" : "2014-03-28",
  "articleSection" : [ "CORS", "WebApi"  ],
  "url" : "https://williamverdolini.github.io/2014/03/28/discitur-CORS"
}
</script>

<p><em>What does <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank">Cross-Origin Resource Sharing</a></em> mean? It’s a mechanism that allows a web application to access resources in another domain.</p>

<p><em>Why is it for</em>? for a number of reasons, all very valid and current:</p>

<ol>
  <li>because with the intensive use of javascript libraries that make AJAX call and the explosion of social networks that provide access to its resources, 
  web applications have become real “rich client application”, which are able to call an high number of functionality and data from external sources</li>
  <li>for safety issues. In fact, all browsers implement a policy that prevents web applications to access external resources except under certain characteristics (<a href="http://en.wikipedia.org/wiki/Same_origin_policy" target="_blank">same-origin policy</a>). </li>
</ol>

<p><em>Why do I talk about</em>? Because it helped me to create an environment of User Acceptance Test completely free! (Venal, but it’s true). 
Seriously, I set the goal to get low-cost and after a while has become almost a personal challenge. In fact in the .NET world are not many providers that allow you to have a server without activation fees or dues (on this front, colleagues of PHP have an easier life).</p>

<p>What I found is <a href="https://somee.com/default.aspx" target="_blank">Somee.com</a>: for small or test provides Windows Server 2012 (to date) with SQL Server without incurring any cost. The management interface is a bit spartan, but with the usual access FTP you can do what it takes.</p>

<p>Beautiful! Except that Somee.com imposes to display into the HTML pages returned by their free servers a bit of advertising. I am not against this barter. The problem lies in how fit this advertising…in fact they made sure that every resource html request to the server is returned with the following suffix: </p>

<script type="syntaxhighlighter" class="brush: html">
<![CDATA[
<!--SCRIPT GENERATED BY SERVER! PLEASE REMOVE-->
<center><a href="http://somee.com">Web hosting by Somee.com</a></center>
</textarea></xml>< /script></noframes></noscript></object></layer></style></title></applet>
<script language="JavaScript" src="http://ads.mgmt.somee.com/serveimages/ad2/WholeInsert4.js">< /script>
<!--SCRIPT GENERATED BY SERVER! PLEASE REMOVE-->
]]></script>
<p> </p>

<p>This “trick” has the unfortunate effect of completely break my angular.js application!!!</p>

<p>In fact all the directives require that the own template has a unique root-node…which, with Somee.com, is no longer true…</p>

<p>I have not resigned myself to the thing (because, from newbie, deploying for the first time the application on these servers, cost me several hours) and I thought back to what mentioned in a <a href="/2014/01/24/discitur-separation_en/" target="_blank">previous article</a>, namely that, thanks to the organization of services and use of a unique baseUrl, is very simple to indicate which server Angular uses for RESTful calls. GOOD!</p>

<p>Thanks to <a href="https://github.com/" target="_blank">Github</a> (which I will never cease to thank!) anyone who registers has available (free of charge), a web space for the publication of their material: <a href="http://pages.github.com/" target="_blank">Github Pages</a>, that is, precisely, the space where I publish these articles. At this point I think I have everything and I could realize my environment with this UAT Environment Management:</p>

<p><img src="/images/discitur/UAT_env.png" /> </p>

<p>Each client then polls the Github server for static resources (.html, .js, .css, etc.) And the Somee server for dynamic resources (services). In this scenario, the client must be able to do CORS call and the web API must be configured to allow access from the outside. Given this scenario, I would also expect that the authorized origin could be configurable and undoable (because production would have different origins or I may have no need of this scenario).</p>

<p>To do this, I followed these simple steps:</p>

<ol>
  <li>installation of Microsoft.Owin.Cors library</li>
  <li>Creating a <a href="https://github.com/williamverdolini/discitur-api/blob/sprint5/Web.config#L29" target="_blank">configuration section for CORS</a></li>
  <li>Creating a a href=”https://github.com/williamverdolini/discitur-api/blob/sprint5/App_Start/Startup.Auth.cs#L107” target=”_blank”&gt;custom class CORS Policy&lt;/a&gt; (with the source to be enabled)</li>
  <li><a href="https://github.com/williamverdolini/discitur-api/blob/sprint5/App_Start/Startup.Auth.cs#L67" target="_blank">Setting CORS policy</a> according to the data in configuration</li>
</ol>

<p>It works. And it’s free!</p>

<p>##Preflighted requests##</p>

<p>It was interesting to see the work the preflighted requests, which are one of the CORS’s policy behaviours browsers apply. Consists in the fact that the browser, under particular conditions (eg. For the presence of custom header), always to ensure safety, before performing an Cross-Origin http request, “knock” to the server with a light request, with basic header and OPTIONS method, to make sure that this call is recognizable by the server.</p>

<p>In the Discitur UAT environment, this behavior is very obvious, in fact, as a result of authentication, through the use of Angular.js interceptor, I insert a custom header with the authentication token. This additional token puts the browser on alert, which starts the mechanism of preflighted requests.</p>

<p> </p>

<p>If there is traffic on the application, you can see that before authentication you have simple requests:</p>

<p><img src="/images/discitur/preflighted.png" /></p>

<p>and with CORS enabled</p>

<p><img src="/images/discitur/preflighted2.png" /></p>

<p>after the authentication, the browser launch the preflight requests with token into the header:</p>

<p><img src="/images/discitur/preflighted3.png" /></p>

<p>each of which “knocks” to the server by requesting authorization to the real call:</p>

<p><img src="/images/discitur/preflighted4.png" /></p>

<p>Essential articles on the subject are: <br />
<a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS" target="_blank">https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS</a><br />
<a href="http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api" target="_blank">http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api</a></p>

<p> </p>
