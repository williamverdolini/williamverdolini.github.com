angular.module("disc.common",[]),angular.module("disc.lesson",["disc.settings","disc.user","disc.common","ui.router","ngSanitize","ui.bootstrap","ui.tinymce"]).config(["$stateProvider","$urlRouterProvider","$uiViewScrollProvider","DisciturSettings",function(a,b,c,d){if(c.useAnchorScroll(),!d.isInMaintenance){var e=function(a,b,c,d,e,f){var g=b.defer(),h=c.lessonId;return a.get({id:h}).then(function(a){a.isPublished||a.author.userid==f.user.userid||g.reject("no Lesson for id:"+h),e.cache.put("lesson",a),g.resolve(a)},function(){g.reject("no Lesson for id:"+h)}),g.promise};a.state("lessonSearch",{url:"lesson?keyword?discipline?school?classroom?rate?tags?publishedOn?publishedBy?startRow?pageSize?orderBy?orderDir",parent:"master.2cl",onEnter:function(){console.log("Entering Lesson Search")},resolve:{lessonsData:["LessonService","$stateParams",function(a,b){return a.search(b)}],lastLessonList:["LessonService",function(a){return a.getLastLessons()}]},views:{sidebar:{templateUrl:"modules/lesson/LessonListSideBar.html",controller:"LessonListSideBarCtrl"},main:{templateUrl:"modules/lesson/LessonList.html",controller:"LessonListCtrl"}}}).state("lessonDetail",{url:"lesson/:lessonId",parent:"master.2cl",onEnter:function(){console.log("Entering Lesson Detail")},resolve:{lessonData:["LessonService","$q","$stateParams","$state","DiscUtil","AuthService",e],lastLessonList:["LessonService",function(a){return a.getLastLessons()}]},views:{sidebar:{templateUrl:"modules/lesson/LessonSideBar.html",controller:"LessonSideBarCtrl"},main:{templateUrl:"modules/lesson/Lesson.html",controller:"LessonCtrl"}}}).state("lessonEdit",{authorized:!0,url:"edit/lesson/:lessonId",parent:"master.1cl",onEnter:["AuthService","lessonData","$location",function(a,b,c){console.log("Entering Lesson Edit"),(!a.user.isLogged||null!=b.lessonId&&b.author.userid!=a.user.userid)&&c.path("lesson")}],templateUrl:"modules/lesson/LessonEdit.html",controller:"LessonEditCtrl",resolve:{lessonData:["LessonService","$q","$stateParams","$state","DiscUtil","AuthService",function(a,b,c,d,f,g){var h=c.lessonId;if(h){var i=f.cache.get("lesson");return angular.isDefined(i)&&i.lessonId.toString()===h?i:e(a,b,c,d,f,g)}return a.newLesson()}]}}).state("404lesson",{url:"404lesson",parent:"master.2cl",onEnter:function(){console.log("master.2cl.404lesson")},resolve:{lastLessonList:["LessonService",function(a){return a.getLastLessons()}]},views:{sidebar:{templateUrl:"modules/lesson/LessonListSideBar.html",controller:"LessonListSideBarCtrl"},main:{controller:"Lesson404Ctrl",templateUrl:"modules/lesson/Lesson404.html"}}})}}]),angular.module("disc.user",["disc.common","ngResource","ui.router","ngSanitize","ui.bootstrap"]).config(["$httpProvider","$stateProvider","$urlRouterProvider","$uiViewScrollProvider",function(a,b,c,d){a.interceptors.push("UserAuthInterceptor"),d.useAnchorScroll(),b.state("userProfile",{url:"user/profile",parent:"master.1cl",authorized:!0,templateUrl:"modules/user/UserProfile.html",controller:"UserProfileCtrl",resolve:{user:["AuthService",function(a){return a.user}]}}).state("userActivation",{url:"user/activation?username?key",parent:"master.1cl",onEnter:function(a){console.log(a)},onExit:function(a){console.log(a)},templateUrl:"modules/user/UserActivation.html",controller:"UserActivationCtrl",resolve:{activation:function(a,b){return a.activate(b).catch(function(){return{notActive:!0}})}}})}]),angular.module("disc.common").value("dictionary",{brand:"Discitur",appTitle:"Discitur - Insieme si migliora",loading:"Caricamento in corso...",lessonTitleHeading:"Titolo della Lezione",lessonTitle:"Titolo",notPublished:"Lezione non pubblicata",specifics:"Caratteristiche",discipline:"Disciplina",school:"Scuola",classroom:"Classe",tags:"Tags",rating:"Valutazione",author:"Pubblicato da",publishedOn:"in data",content:"Contenuto",lessonGoods:"Aspetti positivi",lessonBads:"Aspetti negativi",noLessonGoods:"Nessun aspetto positivo rilevato...",noLessonBads:"Nessun aspetto negativo rilevato!",conclusion:"Conclusioni",comments:"I Commenti",commentPlaceholder:"Inserisci il tuo commento",commentHelp:"Accedi ed esprimi la tua opinione!",commentAnswer:"Rispondi",commentEdit:"Edita",commentPreview:"Anteprima",commentSave:"Salva",commentRequired:"Inserisci almeno un carattere",commentNotDelete:"Il commento non pu\xf2 essere rimosso: altri utenti hanno linkato la tua risposta",ratings:"Le Valutazioni",ratingPlaceholder:"Se vuoi, commenta il tuo giudizio",ratingtHelp:"Sei un docente ed hai provato la lezione? Accedi ed esprimi il tuo giudizio ed aiuta a migliorare la lezione",ratingSave:"Salva",ratingRequired:"Scegli il valore della tua valutazione",ratingNotDelete:"Il commento non pu\xf2 essere rimosso dall'Autore della lezione.",ratingInput:"Il tuo giudizio: ",noLessonIdFound:"Oooops...la Lezione non esiste! <br>Segnalalo al <a href='mailto:support@discitur.org'>supporto tecnico</a>",viewMore:"Approfondisci >>",keywordPlaceholder:"Ricerca la lezione per titolo",advKeyword:"Titolo",disciplinePlaceholder:"Disciplina",schoolPlaceholder:"Scuola",classroomPlaceholder:"Classe",tag:"Caratteristica",searchButton:"Cerca",advancedSearchButton:"Ricerca Avanzata",buttonAdd:"+",addItem:"Aggiungi",buttonDel:"x",cancel:"Annulla",validationError:"Non Valido!",userSignIn:"Accedi",username:"User Name",password:"Password",signInTitle:"Accedi a Discitur",loginButtom:"Login",login:"Login",forgottenPwdHelp:"Inserisci lo UserName associato al tuo account e ti sar\xe0 inviata una email con nuove credenziali di accesso.",sendMail:"Invia email",usernameNotValid:"User Name NON valido",register:"Registrati",userProfile:"Il tuo Profilo",userLessons:"Le tue Lezioni",userSignOff:"Esci",editLessonButton:"Modifica",requiredField:"Dato obbligario",showHideHelp:"Mostra/Nascondi Help",helpTitle:"<h6>Marcando il check <b>Pubblica</b> la lezione sar\xe0 visibile a tutti.<br />Tieni la lezione privata mentre la stai preparando. Sar\xe0 visibile solo a te ed accessibile tramite la funzionalit\xe0 di profilo <b>Le tue Lezioni</b>.</h6>",helpSpecifics:"<h6>Digitando sui campi il sistema ti proporr\xe0 dei valori gi\xe0 presenti a sistema.<br /><br /><p>Se non soddisfano alle tue esigenze inserisci i dati come meglio preferisci.</p></h6>",helpTags:"<h6>I  <b>Tag</b> consentono di marcare e poter ricercare la lezione per caratteristiche interdisciplinari.<br /><br /><p>Digitando, il sistema ti proporr\xe0 dei valori gi\xe0 presenti,ma se non soddisfano alle tue esigenze, inserisci i dati come meglio preferisci.</p></h6>",helpContent:'<h6>Inserisci il <b>Contenuto</b> della lezione.<br /><br />Dettaglia i passaggi e gli strumenti utilizzati e descrivi il metodo o l\'approccio utilizzato,in modo che altri docenti possano comprendere la lezione ed imparare.<br /><br /><p>Per poter inserire immagini o video utilizza le funzionalit\xe0 dell\'editor a fianco,ma ricorda, tutte le immagini devono essere caricate in un tuo spazio web ed accessibiliattraverso un indirizzo web, da inserire nel campo <b>Source</b>.</p><p>Ti suggeriamo i seguenti se non hai gi\xe0 un tuo spazio web:<ul><li><a href="http://www.drive.google.com/">Google Drive</a></li><li><a href="https://www.dropbox.com/">Dropbox</a></li></ul></p></h6>',helpFeedbacks:"<h6>I  <b>Feedback</b> sono il frutto della retrospettiva della lezione, della tua analisi, del tuo punto di vista.<br /><br />Cosa \xe8 andato bene? Quali gli aspetti positivi della lezione?<br /><br />Cosa invece non ha funzionato? Cosa poteva essere evitato? Cosa migliorato?<br /><br /><p>Metti la qualit\xe0 dell'insegnamento sopra al resto e non temere di indicare gli aspetti negativi riscontrati.<br />Sono principalmente questi che consentono di migliorare la tecnica, il metodo e la qualit\xe0 dell'insegnamento.<br />Sbagliando si impara!</p></h6>",helpConclusion:"<h6>Nelle <b>Conclusioni</b> inserisci i punti salienti della lezione.<br /><br />Il paragrafo \xe8 utilizzato nella lista dei risultati della ricerca come <i>abstract</i> della lezione,perci\xf2 \xe8 importante riuscire a sintetizzare il contenuto e gli aspetti caratterizzanti.</h6>",editTooltip:"Modifica",deleteTooltip:"Elimina",lastLessonsTitle:"Le ultime lezioni pubblicate",socialTitleFBLike:"I Like it",socialTitleGPone:"Google +1",socialTitleTWShare:"Share on Twitter",socialTitleFBShare:"Share on Facebook",socialTitleGPShare:"Share on Google Plus",socialTitleLIShare:"Share on LinkedIn",name:"Nome",surname:"Cognome",email:"Email",confirmPassword:"Conferma Password",signupButton:"Registrati",requiredUserName:"UserName obbligatorio",minLengthUserName:"Inserisci uno User Name di almeno 4 caratteri",requiredPassword:"Password obbligatoria",minLengthPassword:"inserisci una Password di almeno 7 caratteri",requiredName:"Nome obbligatorio",requiredSurname:"Cognome obbligatorio",requiredEmail:"Email obbligatoria",validEmail:"Email non valida",requiredConfirmPassword:"Conferma Password obbligatoria",minLengthConfirmPassword:"inserisci una Conferma Password di almeno 7 caratteri",matchConfirmPassword:"Conferma Password non corretta",forgottenPassword:"Password dimenticata?",changePassword:"Modifica Password",currentPassword:"Password attuale",newPassword:"Nuova password",confirmPassword:"Conferma password",requiredNewPassword:"Nuova Password obbligatoria",minLengthNewPassword:"inserisci una nuova Password di almeno 7 caratteri",changedPassword:"Password aggiornata con successo.",confirm:"Conferma",modify:"Modifica",testEnv:"Ambiente di Test",signupSuccess:"Registrazione avvenuta con successo. Controlla la tua email ed attiva il tuo account.",activationSuccess:"Il tuo account \xe8 stato attivato. Accedi e inizia a dare il tuo contributo!",activationFailed:"Il tuo account NON \xe8 stato attivato. Controlla la tua mail o contatta il supporto tecnico."}).value("overrides",{LessonCtrl:{lessonGoods:"Cosa \xe8 andato bene",lessonBads:"Cosa \xe8 andato male"},LessonListCtrl:{publishedOn:"Pubblicato il",noLessonFound:"Nessuna Lezione trovata."},LessonListSideBarCtrl:{newLessonButton:"Nuova Lezione"},LessonEditCtrl:{saveLessonButton:"Salva la Lezione",deleteLessonButton:"Elimina la Lezione",cancelButton:"Annulla",publicLesson:"Pubblica"}}).value("errors",{discerr01:"Username gi\xe0 usato da un altro account",discerr02:"Email gi\xe0 associata ad un altro account",discerr03:"Username o password non corretti"}),angular.module("disc.common").factory("ErrorDTO",function(){function a(){this.code=null,this.description=null}return a}).factory("LabelService",["dictionary","overrides","errors","ErrorDTO",function(a,b,c,d){return{get:function(c,d){return b[c]&&b[c][d]?b[c][d]:a[d]||"Label ("+d+") not set!"},apiErrorCode:function(a){var b=new d;return b.code=a,b.description=c[a]||a,b},apiError:function(a){var b=[];if(a.ModelState&&a.ModelState.discerrors)for(var e=a.ModelState.discerrors,f=0;f<e.length;f++){var g=new d;g.code=e[f],g.description=c[e[f]]?c[e[f]]:e[f],b.push(g)}else{var g=new d;g.code=a,g.description=a,b.push(g)}return b}}}]),angular.module("disc.common").factory("DiscUtil",["$cacheFactory",function(a){var b=function(a){var c="";for(var d in a)c+=a[d].constructor===Object?b(a[d]):d+":"+a[d]+" ";return c};return{validateInput:function(a,c,d){if(angular.isUndefined(d)||"[object Object]"!==Object.prototype.toString.call(d))throw{code:20001,message:"invalid Input Type for "+a+" :"+b(d)};if(angular.isDefined(d)){for(key in d)if(0!=key.indexOf("$$")&&0!=key.indexOf("_")&&!c.hasOwnProperty(key))throw{code:20002,message:"invalid Input Parameter for "+a+" :"+b(d)};for(key in c)!angular.isUndefined(d[key])&&null!=d[key]||null==c[key]||(d[key]=c[key])}},cache:a("disciturCache")}}]).factory("LoadingInterceptor",["$q","$rootScope","DisciturSettings",function(a,b,c){return{request:function(d){return d.url.indexOf(c.apiUrl)>=0&&(b.$loading=!0),d||a.when(d)},response:function(d){return d.config.url.indexOf(c.apiUrl)>=0&&(b.$loading=!1),d||a.when(d)},responseError:function(c){return b.$loading&&(b.$loading=!1),a.reject(c)}}}]),angular.module("disc.common").directive("wrInput",["$rootScope","LabelService",function(a,b){return{restrict:"E",templateUrl:"modules/common/wrInput.html",replace:!0,transclude:!1,scope:{wrText:"=",wrRef:"=",editText:"&",removeText:"&?"},link:function(a,c,d){var e=function(a){return b.get("LessonRatingDrv",a)},f=a.wrText;a.local={edit:!1,isDeletable:angular.isDefined(d.removeText),cssClass:angular.isDefined(d.wrClass)?d.wrClass:"",cssStyle:angular.isDefined(d.wrStyle)?d.wrStyle:""},a.labels={editTooltip:e("editTooltip"),deleteTooltip:e("deleteTooltip")},a.actions={edit:function(){a.local.edit=!a.local.edit,f!=a.wrText&&a.editText({ref:a.wrRef})},remove:function(){a.removeText({ref:a.wrRef})}}}}}]),angular.module("disc.common").directive("socialBar",["$rootScope","DisciturBaseCtrl","$injector",function(a,b,c){return{restrict:"E",templateUrl:"modules/common/socialBar.html",replace:!0,transclude:!1,scope:{cssClass:"@?",absUrl:"@",urlTitle:"@?"},link:function(a){c.invoke(b,this,{$scope:a}),a._ctrl="socialBarDrv",a.local={cssClass:null,absUrl:null,urlTitle:null,FBShareHref:null,FBLikeHref:null,TWShareHref:null,GPOneHref:null,GPShareHref:null,LIShareHref:null},a.labels={socialTitleFBLike:a.getLabel("socialTitleFBLike"),socialTitleGPone:a.getLabel("socialTitleGPone"),socialTitleTWShare:a.getLabel("socialTitleTWShare"),socialTitleFBShare:a.getLabel("socialTitleFBShare"),socialTitleGPShare:a.getLabel("socialTitleGPShare"),socialTitleLIShare:a.getLabel("socialTitleLIShare")},a.local.cssClass=a.cssClass||"social-bar",a.local.absUrl=encodeURIComponent(a.absUrl),a.local.urlTitle=encodeURIComponent(a.urlTitle),a.local.FBShareHref="http://www.facebook.com/sharer.php?u="+a.local.absUrl+(a.urlTitle?"&t="+a.local.urlTitle:""),a.local.FBLikeHref="http://www.facebook.com/plugins/like.php?href="+a.local.absUrl,a.local.TWShareHref="http://twitter.com/share?url="+a.local.absUrl+(a.urlTitle?"&text="+a.local.urlTitle:"")+"&via=__wilver__",a.local.GPOneHref="https://apis.google.com/_/+1/fastbutton?usegapi=1&size=large&url="+a.local.absUrl,a.local.GPShareHref="https://plus.google.com/share?url="+a.local.absUrl,a.local.LIShareHref="http://www.linkedin.com/shareArticle?url="+a.local.absUrl}}}]),angular.module("disc.common").directive("pwCheck",["$rootScope",function(){return{restrict:"A",require:"ngModel",scope:{pwCheck:"="},link:function(a,b,c,d){if(d){var e=function(a){var b=d.$viewValue===a;d.$setValidity("pwmatch",b)};a.$watch(function(){return a.pwCheck},function(){e(a.pwCheck)}),a.$watch(function(){return d.$viewValue},function(){e(a.pwCheck)})}}}}]),angular.module("disc.common").directive("serverValidation",["$rootScope",function(){return{restrict:"A",require:"ngModel",scope:{serverValidation:"&"},link:function(a,b,c,d){d&&b.blur(function(){d.$setValidity("serverCheck",!1),a.serverValidation({inputValue:d.$viewValue}).then(function(a){d.$setValidity("serverCheck",a)},function(){d.$setValidity("serverCheck",!1)})})}}}]),angular.module("disc.lesson").factory("LessonDTO",function(){function a(){this.lessonId=null,this.title=null,this.discipline=null,this.school=null,this.classroom=null,this.rate=null,this.author=null,this.isPublished=!1,this.publishedOn=null,this.content=null,this.conclusion=null,this.lastModifUser=null,this.version=null,this.goods=[],this.bads=[],this.tags=[],this.ratings=[],this.comments=[]}return a}).factory("LessonSummaryDTO",function(){function a(){this.lessonId=null,this.title=null}return a}).factory("CommentDTO",function(){function a(){this.lessonId=null,this.id=null,this.content=null,this.date=null,this.parentId=null,this.level=0,this.author={userid:null,username:null,image:null},this.order=0,this.status="I"}return a}).factory("RatingDTO",function(){function a(){this.id=null,this.lessonId=null,this.author={userid:null,username:null,image:null},this.rating=null,this.content=null,this.date=null,this.version=null}return a}).factory("LessonService",["$resource","$http","$q","LessonDTO","CommentDTO","RatingDTO","LessonSummaryDTO","DisciturSettings","DiscUtil","$cacheFactory",function(a,b,c,d,e,f,g,h,i,j){var k,l,m=function(a){var b=new d;return b.lessonId=a.LessonId,b.title=a.Title,b.discipline=a.Discipline,b.school=a.School,b.classroom=a.Classroom,b.author={name:a.Author.Name,surname:a.Author.Surname,userid:a.Author.UserId,username:a.Author.UserName},b.isPublished="1"==a.Published,b.publishedOn=a.PublishDate,b.rate=a.Rate,angular.forEach(a.FeedBacks,function(a){var b={id:a.LessonFeedbackId,content:a.Feedback,status:"I"};1==a.Nature&&this.goods.push(b),2==a.Nature&&this.bads.push(b)},b),angular.forEach(a.Tags,function(a){this.tags.push({content:a.LessonTagName,status:"I"})},b),b.tags.status="I",b.content=a.Content,b.conclusion=a.Conclusion,b.lastModifUser=a.LastModifUser,b.version=a.Vers,b},n=function(a){for(var b=[],c=0;c<a.length;c++)b.push(m(a[c]));return b},o=function(a){var b={startRow:a.StartRow,count:a.Count,pageSize:a.PageSize,lessons:n(a.Records)};return b},p=function(a){var b=new e;return b.lessonId=a.LessonId,b.id=a.Id,b.content=a.Content,b.date=a.Date,b.parentId=a.ParentId||0,b.level=a.Level,b.author.userid=a.Author.UserId,b.author.username=a.Author.UserName,b.author.image=a.Author.Picture,b},q=function(a){for(var b=[],c=0;c<a.length;c++)b.push(p(a[c]));b.length>0&&b.sort(function(a,b){return a.id-b.id});for(var c=0;c<b.length;c++)b[c]._num=c+1,b[c]._order=s(b[c],b);return b},r=function(a,b){return Array(Math.max(b-String(a).length+1,0)).join(0)+a},s=function(a,b){var c="";if(a.level>0)for(var d=0;d<b.length;d++)a.parentId==b[d].id&&(c+=s(b[d],b),c+=r(a._num,3));return 0==a.level&&(c="0."+r(a._num,3)+c),c},t=function(a){for(var b=[],c=0;c<a.length;c++)b.push(v(a[c]));return b.length>0&&b.sort(function(a,b){return a.date-b.date}),b},u=function(a){for(var b=[],c=0;c<a.length;c++){var d=new g;d.lessonId=a[c].Key,d.title=a[c].Value,b.push(d)}return b},v=function(a){var b=new f;return b.id=a.Id,b.lessonId=a.LessonId,b.content=a.Content,b.date=a.CreationDate,b.rating=a.Rating,b.author.userid=a.Author.UserId,b.author.username=a.Author.UserName,b.author.image=a.Author.Picture,b.version=a.Vers,b},w=function(a){var b={};return b.LessonId=a.lessonId,b.Title=a.title,b.Discipline=a.discipline,b.School=a.school,b.Classroom=a.classroom,b.Rate=null,b.Author={Name:a.author.name,Surname:a.author.surname,UserId:a.author.userid},b.Published=a.isPublished?1:0,b.PublishedOn=a.publishedOn,b.FeedBacks=[],angular.forEach(a.goods,function(a){var b={LessonFeedbackId:a.id,Feedback:a.content,Nature:1};this.FeedBacks.push(b)},b),angular.forEach(a.bads,function(a){var b={LessonFeedbackId:a.id,Feedback:a.content,Nature:2};this.FeedBacks.push(b)},b),b.Tags=[],angular.forEach(a.tags,function(b){var c={LessonId:a.lessonId,LessonTagName:b.content,status:b.status};this.Tags.push(c)},b),b.Content=a.content,b.Conclusion=a.conclusion,b.LastModifUser=a.lastModifUser,b.Vers=a.version,a.status&&(b.status=a.status),b},x=function(a,d){switch(a){case"discipline":i.validateInput("LessonService.getDistinctValues.discipline",{disciplineQ:null},d);break;case"school":i.validateInput("LessonService.getDistinctValues.school",{schoolQ:null},d);break;case"classroom":i.validateInput("LessonService.getDistinctValues.classroom",{classroomQ:null},d);break;case"tag":i.validateInput("LessonService.getDistinctValues.tag",{tagQ:null},d);break;default:throw{code:20003,message:"invalid type string for LessonService.getDistinctValues :"+a}}var e=c.defer();return b({method:"GET",url:h.apiUrl+"lesson",params:d,cache:!0}).success(function(a){e.resolve(a)}).error(function(a){e.reject("Error for LessonService.getDistinctValues:"+a)}),e.promise},y={get:function(a){i.validateInput("LessonService.get",{id:null},a);var d=c.defer();return b.get(h.apiUrl+"lesson/"+a.id,{cache:!0}).success(function(a){d.resolve(m(a))}).error(function(){d.reject("no Lesson for id:"+a.id)}),d.promise},search:function(a){i.validateInput("LessonService.search",{keyword:null,inContent:null,discipline:null,school:null,classroom:null,rate:null,tags:null,publishedOn:null,publishedBy:null,startRow:0,pageSize:3,orderBy:"PublishDate",orderDir:"DESC"},a);var d=c.defer();return b({method:"GET",url:h.apiUrl+"lesson",params:a}).success(function(b){k=a,l=o(b),d.resolve(l)}).error(function(a){d.reject("Error for search:"+a)}),d.promise},getPage:function(a){return i.validateInput("LessonService.getPage",{pageNum:null},a),k.startRow=(a.pageNum-1)*k.pageSize,k},getDisciplines:function(a){return x("discipline",{disciplineQ:a})},getSchools:function(a){return x("school",{schoolQ:a})},getClassRooms:function(a){return x("classroom",{classroomQ:a})},getTags:function(a){return x("tag",{tagQ:a})},getComments:function(a){i.validateInput("LessonService.getComments",{id:null},a);var d=c.defer();return b({method:"GET",url:h.apiUrl+"lesson/"+a.id+"/comments",cache:!0}).success(function(a){d.resolve(q(a))}).error(function(a){d.reject("Error for getting comments on lesson id:'+ inputParams.id + ' -> "+a)}),d.promise},createComment:function(a,d){i.validateInput("LessonService.createComment",new e,a);var f=c.defer();return b({method:"POST",url:h.apiUrl+"lesson/"+a.lessonId+"/comment",data:a}).success(function(b){j.get("$http").remove(h.apiUrl+"lesson/"+a.lessonId+"/comments");var c=p(b);c=y.setCommentPrivates(c,d),f.resolve(c)}).error(function(b){f.reject("Error saving comment on lesson id:"+a.lessonId+" -> "+b)}),f.promise},updateComment:function(a){i.validateInput("LessonService.updateComment",new e,a);var d=c.defer();return b({method:"PUT",url:h.apiUrl+"lesson/"+a.lessonId+"/comment/"+a.id,data:a}).success(function(b){j.get("$http").remove(h.apiUrl+"lesson/"+a.lessonId+"/comments");var c=p(b);c._num=a._num,c._order=a._order,d.resolve(c)}).error(function(b){d.reject("Error editing comment on lesson id:"+a.lessonId+" -> "+b)}),d.promise},deleteComment:function(a){i.validateInput("LessonService.deleteComment",new e,a);var d=c.defer();return b({method:"PUT",url:h.apiUrl+"lesson/"+a.lessonId+"/comment/"+a.id+"/delete",data:a}).success(function(){d.resolve(a)}).error(function(b){d.reject("Error deleting comment on lesson id:"+a.lessonId+" -> "+b)}),d.promise},setCommentPrivates:function(a,b){return i.validateInput("LessonService.setCommentPrivates",new e,a),b&&b.constructor==Array&&(a._num=b.length+1,a._order=s(a,b)),a},getRatings:function(a){i.validateInput("LessonService.getRatings",{id:null},a);var d=c.defer();return b({method:"GET",url:h.apiUrl+"lesson/"+a.id+"/ratings",cache:!0}).success(function(a){d.resolve(t(a))}).error(function(a){d.reject("Error for getting ratings on lesson id:'+ inputParams.id + ' -> "+a)}),d.promise},createRating:function(a){i.validateInput("LessonService.createRating",new f,a);var d=c.defer();return b({method:"POST",url:h.apiUrl+"lesson/"+a.lessonId+"/rating",data:a}).success(function(b){j.get("$http").remove(h.apiUrl+"lesson/"+a.lessonId+"/ratings");var c=v(b);d.resolve(c)}).error(function(b){d.reject("Error creating rating on lesson id:"+a.lessonId+" -> "+b)}),d.promise},updateRating:function(a){i.validateInput("LessonService.updateRating",new f,a);var d=c.defer();return b({method:"PUT",url:h.apiUrl+"lesson/"+a.lessonId+"/rating/"+a.id,data:a}).success(function(b){j.get("$http").remove(h.apiUrl+"lesson/"+a.lessonId+"/ratings"),j.get("$http").remove(h.apiUrl+"lesson/"+a.lessonId);var c=v(b);d.resolve(c)}).error(function(b){d.reject("Error updating rating on lesson id:"+a.lessonId+" -> "+b)}),d.promise},deleteRating:function(a){i.validateInput("LessonService.deleteRating",new f,a);var d=c.defer();return b({method:"PUT",url:h.apiUrl+"lesson/"+a.lessonId+"/rating/"+a.id+"/delete",data:a}).success(function(b,c){c>=200&&300>c?d.resolve(a):d.reject("Error deleting comment on lesson id:"+a.lessonId+" -> "+arguments.toString())}).error(function(b){d.reject("Error deleting comment on lesson id:"+a.lessonId+" -> "+b)}),d.promise},update:function(a){i.validateInput("LessonService.update",new d,a);var e=w(a),f=c.defer();return b({method:"PUT",url:h.apiUrl+"lesson/"+e.LessonId,data:e}).success(function(a){j.get("$http").remove(h.apiUrl+"lesson/"+e.LessonId),j.get("$http").remove(h.apiUrl+"lesson?lastNum="+h.lastLessonsNum),f.resolve(m(a))}).error(function(a){f.reject("Error updating lesson id:"+e.lessonId+" -> "+a)}),f.promise},create:function(a){i.validateInput("LessonService.create",new d,a);var e=w(a),f=c.defer();return b({method:"POST",url:h.apiUrl+"lesson",data:e}).success(function(a){j.get("$http").remove(h.apiUrl+"lesson?lastNum="+h.lastLessonsNum),f.resolve(m(a))}).error(function(a){f.reject("Error creating lesson id:"+e.lessonId+" -> "+a)}),f.promise},newLesson:function(){return new d},getLastLessons:function(){var a=c.defer();return b({method:"GET",url:h.apiUrl+"lesson",params:{lastNum:h.lastLessonsNum},cache:!0}).success(function(b){a.resolve(u(b))}).error(function(b){a.reject("Error for getLastLessons:"+b)}),a.promise}};return y}]),angular.module("disc.lesson").directive("lessonComment",["$rootScope","LabelService","LessonService","AuthService","CommentDTO","$timeout",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"modules/lesson/LessonComment.html",replace:!0,transclude:!1,scope:{comment:"=?",lessonId:"@",addComment:"&",deleteComment:"&"},link:function(g,h){var i=function(a){return b.get("LessonCtrl",a)},j=h.find("form");g.local={commentText:null,commentError:null,UserCommentForm:j.controller("form"),base:angular.isUndefined(g.comment),isLogged:d.user.isLogged,sameUser:g.comment?g.comment.author.username==d.user.username:!1,answer:!1,edit:!1,showDeleteCommentErr:!1},g.labels={comments:i("comments"),commentPlaceholder:i("commentPlaceholder"),commentHelp:i("commentHelp"),commentAnswer:i("commentAnswer"),commentEdit:i("commentEdit"),commentPreview:i("commentPreview"),commentSave:i("commentSave"),commentRequired:i("commentRequired"),commentNotDelete:i("commentNotDelete"),editTooltip:i("editTooltip"),deleteTooltip:i("deleteTooltip")},g.actions={openSignIn:function(){a.$broadcast("disc.login",g.actions)},createComment:function(){var a=g.local.UserCommentForm,b=a.CommentTXT;if(b.$valid){var f=new e;f.lessonId=g.lessonId,f.content=b.$modelValue,f.parentId=g.comment?g.comment.id:null,f.level=g.comment?g.comment.level+1:0,f.author.userid=d.user.userid,c.createComment(f).then(function(b){g.addComment({comment:b}),g.local.base||(g.local.answer=!1),g.local.commentText="",a.$setPristine()})}},updateComment:function(){var a=g.local.UserEditCommentForm,b=a.CommentTXT;if(b.$valid){var d=new e;angular.extend(d,g.comment),d.content=b.$modelValue,c.updateComment(d).then(function(b){g.comment=b,g.local.edit=!1,a.$setPristine()})}},deleteComment:function(){c.deleteComment(g.comment).then(function(a){g.deleteComment({comment:a})},function(){g.local.showDeleteCommentErr=!0,f(function(){g.local.showDeleteCommentErr=!1},5e3)})},openUserComment:function(){g.local.isLogged||!g.actions.openSignIn(),g.local.answer=!g.local.answer}},g.$watch(function(){return d.user.isLogged},function(){g.local.isLogged=d.user.isLogged,g.local.sameUser=g.comment?g.comment.author.username==d.user.username:!1})}}}]),angular.module("disc.lesson").directive("lessonRating",["$rootScope","LabelService","LessonService","AuthService","RatingDTO","$timeout",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"modules/lesson/LessonRating.html",replace:!0,transclude:!1,scope:{userRating:"=?",lessonId:"@",addRating:"&",deleteRating:"&"},link:function(a,g){var h=function(a){return b.get("LessonRatingDrv",a)},i=function(){a.userRating=new e,a.userRating.lessonId=a.lessonId,a.userRating.author.userid=d.user.userid,a.userRating.author.username=d.user.username,a.userRating.author.image=d.user.image,a.local.sameUser=!0,a.local.edit=!0},j=g.find("form");a.local={ratingText:null,ratingError:null,UserRatingForm:j.controller("form"),newRating:angular.isUndefined(a.userRating),user:d.user,sameUser:a.userRating?a.userRating.author.username==d.user.username:!1,edit:!1,EditText:"",EditRating:null,showDeleteRatingErr:!1,showNoRatingErr:!1},a.labels={ratings:h("ratings"),ratingPlaceholder:h("ratingPlaceholder"),ratingtHelp:h("ratingtHelp"),ratingEdit:h("ratingEdit"),ratingPreview:h("ratingPreview"),ratingSave:h("ratingSave"),ratingRequired:h("ratingRequired"),ratingNotDelete:h("ratingNotDelete"),ratingInput:h("ratingInput"),editTooltip:h("editTooltip"),deleteTooltip:h("deleteTooltip")},a.actions={saveRating:function(){var b=a.local.UserRatingForm,g=b.EditText;if(a.local.EditRating>0)if(a.local.newRating){var h=new e;h.lessonId=a.lessonId,h.rating=a.local.EditRating,h.content=g.$modelValue,h.author.userid=d.user.userid,c.createRating(h).then(function(c){a.addRating({rating:c}),b.$setPristine()})}else a.userRating.rating=a.local.EditRating,a.userRating.content=g.$modelValue,c.updateRating(a.userRating).then(function(c){a.userRating=c,a.local.edit=!1,b.$setPristine()});else a.local.showNoRatingErr=!0,f(function(){a.local.showNoRatingErr=!1},5e3)},deleteRating:function(){c.deleteRating(a.userRating).then(function(b){a.deleteRating({rating:b})},function(){a.local.showDeleteRatingErr=!0,f(function(){a.local.showDeleteRatingErr=!1},5e3)})},editRating:function(){a.local.edit=!a.local.edit,a.local.EditText=a.userRating.content,a.local.EditRating=a.userRating.rating}},a.local.newRating&&a.local.user.isLogged&&i(),a.$watch(function(){return a.local.user.isLogged},function(){a.local.newRating&&i(),a.local.sameUser=a.userRating?a.userRating.author.username==a.local.user.username:!1})}}}]),angular.module("disc.lesson").controller("LessonCtrl",["$scope","LabelService","LessonService","$sce","lessonData","$rootScope","AuthService","CommentDTO","DisciturBaseCtrl","$injector",function(a,b,c,d,e,f,g,h,i,j){j.invoke(i,this,{$scope:a}),a._ctrl="LessonCtrl",a.labels={specifics:a.getLabel("specifics"),discipline:a.getLabel("discipline"),school:a.getLabel("school"),classroom:a.getLabel("classroom"),author:a.getLabel("author"),publishedOn:a.getLabel("publishedOn"),rating:a.getLabel("rating"),content:a.getLabel("content"),lessonGoods:a.getLabel("lessonGoods"),noLessonGoods:a.getLabel("noLessonGoods"),lessonBads:a.getLabel("lessonBads"),noLessonBads:a.getLabel("noLessonBads"),conclusion:a.getLabel("conclusion"),comments:a.getLabel("comments"),ratings:a.getLabel("ratings"),ratingtHelp:a.getLabel("ratingtHelp"),notPublished:a.getLabel("notPublished")},a.local={commentText:null,commentError:null,commentTexts:[],commentErrors:[],user:{isLogged:!1,userId:!1}},a.actions={saveComment:function(b){var d=b?a.local["UserCommentFormOn"+b.id]:a.local.UserCommentForm,e=d.CommentTXT;if(e.$valid){var f=new h;f.lessonId=a.lesson.lessonId,f.content=e.$modelValue,f.parentId=b?b.id:null,f.level=b?b.level+1:0,f.author.userid=g.user.userid,c.saveComment(f,a.lesson.comments).then(function(c){a.lesson.comments.push(c),b?(b.anwser=!1,a.local.commentTexts[b.id]=""):a.local.commentText=""})}},addComment:function(b){a.lesson.comments.push(c.setCommentPrivates(b,a.lesson.comments))},deleteComment:function(b){for(var c=-1,d=0;d<a.lesson.comments.length;d++)a.lesson.comments[d].id===b.id&&(c=d);c>-1&&a.lesson.comments.splice(c,1)},openUserComment:function(b){a.isLogged||!a.actions.openSignIn(),b.anwser=!b.anwser},userHasVoted:function(){for(var b=0;b<a.lesson.ratings.length;b++)if(a.lesson.ratings[b].author.userid===g.user.userid)return!0;return!1},addRating:function(b){a.lesson.ratings.push(b)},deleteRating:function(b){for(var c=-1,d=0;d<a.lesson.ratings.length;d++)a.lesson.ratings[d].id===b.id&&(c=d);c>-1&&a.lesson.ratings.splice(c,1)}},a.isLogged=g.user.isLogged,a.local.user.isLogged=g.user.isLogged,a.local.user.userId=g.user.userid,a.$watch(function(){return g.user.isLogged},function(){a.isLogged=g.user.isLogged,a.local.user.isLogged=g.user.isLogged,a.local.user.userId=g.user.userid});var k=e;a.lesson=k,a.lesson.comments=[],c.getComments({id:a.lesson.lessonId}).then(function(b){a.lesson.comments=b}),a.lesson.ratings=[],c.getRatings({id:a.lesson.lessonId}).then(function(b){a.lesson.ratings=b})}]),angular.module("disc.lesson").controller("LessonSideBarCtrl",["$scope","AuthService","$state","lessonData","lastLessonList","DisciturBaseCtrl","$injector",function(a,b,c,d,e,f,g){g.invoke(f,this,{$scope:a}),a._ctrl="LessonSideBarCtrl",a.labels={lastLessonsTitle:a.getLabel("lastLessonsTitle"),editLessonButton:a.getLabel("editLessonButton")},a.local={user:b.user,lesson:d,lastLessonList:e},a.actions={editLesson:function(){c.go("lessonEdit",{lessonId:d.lessonId},{inherit:!1})
}}}]),angular.module("disc.lesson").controller("Lesson404Ctrl",["$scope","LabelService",function(a,b){_getLabel=function(a){return b.get("Lesson404Ctrl",a)},a.labels={noLessonIdFound:_getLabel("noLessonIdFound")},console.log("404 Controller")}]),angular.module("disc.lesson").controller("LessonListCtrl",["$scope","LabelService","lessonsData","LessonService","$state",function(a,b,c,d,e){a.labels,a.lessons,a.totalLessons,a.currentPage,a.pageSize;var f=function(a){return b.get("LessonListCtrl",a)},g=function(b){a.lessons=b.lessons,a.totalLessons=b.count,a.currentPage=(b.startRow-b.startRow%b.pageSize)/b.pageSize+1,a.pageSize=b.pageSize};a.getPage=function(a){e.go("lessonSearch",d.getPage(a),{reload:!0})},a.labels={publishedOn:f("publishedOn"),viewMore:f("viewMore"),noLessonFound:f("noLessonFound"),notPublished:f("notPublished")},g(c)}]),angular.module("disc.lesson").controller("LessonSearchCtrl",["$scope","LabelService","$state","$modal",function(a,b,c,d){_getLabel=function(a){return b.get("LessonSearchCtrl",a)},a.search=function(){c.go("lessonSearch",{keyword:a.keyword},{inherit:!1}),a.keyword=null},a.openAdvSearch=function(){var a=d.open({backdrop:!0,windowClass:"modal",templateUrl:"LessonAdvSearch",controller:"LessonAdvSearchCtrl"});a.result.then(function(){},function(){console.log("Modal dismissed at: "+new Date)})},a.labels={keywordPlaceholder:_getLabel("keywordPlaceholder"),searchButton:_getLabel("searchButton"),advancedSearchButton:_getLabel("advancedSearchButton")},a.keyword}]),angular.module("disc.lesson").controller("LessonAdvSearchCtrl",["$scope","$modalInstance","LabelService","LessonService","$state",function(a,b,c,d,e){_getLabel=function(a){return c.get("LessonAdvSearchCtrl",a)},a.getDisciplines=function(a){return d.getDisciplines(a)},a.getSchools=function(a){return d.getSchools(a)},a.getClassRooms=function(a){return d.getClassRooms(a)},a.getTags=function(a){return d.getTags(a)},a.addSearchedTag=function(){a.local.searchedTags.push(a.local.tag),a.local.tag=null},a.selectTag=function(){a.addSearchedTag()},a.select=function(b){a.local.errors[b]=!1},a.hoveringOver=function(b){a.local.overStar=b},a.ok=function(){b.close(0)},a.cancel=function(){b.dismiss("cancel")},a.advSearch=function(){a.local.searchForm.$valid?(e.go("lessonSearch",{keyword:a.local.keyword,discipline:a.local.discipline,school:a.local.school,classroom:a.local.classroom,rate:a.local.rate>0?a.local.rate:null,tags:0==a.local.searchedTags.length?null:a.local.searchedTags.join()},{inherit:!1}),a.local.keyword=null,a.local.discipline=null,a.local.school=null,a.local.classroom=null,a.ok()):(a.local.searchForm.discipline.$invalid&&(a.local.errors.discipline=!0),a.local.searchForm.school.$invalid&&(a.local.errors.school=!0),a.local.searchForm.classroom.$invalid&&(a.local.errors.classroom=!0))},a.local={keyword:null,discipline:null,school:null,classroom:null,rate:0,searchedTags:[],tag:null,searchForm:{},showErrors:!1,errors:{discipline:!1,school:!1,classroom:!1}},a.labels={advKeyword:_getLabel("advKeyword"),discipline:_getLabel("discipline"),school:_getLabel("school"),classroom:_getLabel("classroom"),rating:_getLabel("rating"),tag:_getLabel("tag"),cancel:_getLabel("cancel"),buttonAdd:_getLabel("buttonAdd"),buttonDel:_getLabel("buttonDel"),searchButton:_getLabel("searchButton"),advancedSearchButton:_getLabel("advancedSearchButton"),validationError:_getLabel("validationError")}}]),angular.module("disc.lesson").controller("LessonListSideBarCtrl",["$scope","DisciturBaseCtrl","$injector","AuthService","$state","lastLessonList",function(a,b,c,d,e,f){c.invoke(b,this,{$scope:a}),a._ctrl="LessonListSideBarCtrl",a.labels={lastLessonsTitle:a.getLabel("lastLessonsTitle"),newLessonButton:a.getLabel("newLessonButton")},a.local={user:d.user,lastLessonList:f},a.actions={newLesson:function(){e.go("lessonEdit")}}}]),angular.module("disc.lesson").controller("LessonEditCtrl",["$scope","AuthService","lessonData","LessonService","$state","DisciturBaseCtrl","$injector","DisciturSettings",function(a,b,c,d,e,f,g,h){g.invoke(f,this,{$scope:a}),a._ctrl="LessonEditCtrl";var i=function(){var b=localStorage.getItem(h.viewHelp);null!==b?a.local.viewHelp=a.$eval(b):localStorage.setItem(h.viewHelp,a.local.viewHelp)};a.labels={lessonTitleHeading:a.getLabel("lessonTitleHeading"),lessonTitle:a.getLabel("lessonTitle"),specifics:a.getLabel("specifics"),discipline:a.getLabel("discipline"),school:a.getLabel("school"),classroom:a.getLabel("classroom"),tags:a.getLabel("tags"),author:a.getLabel("author"),publishedOn:a.getLabel("publishedOn"),rating:a.getLabel("rating"),content:a.getLabel("content"),lessonGoods:a.getLabel("lessonGoods"),noLessonGoods:a.getLabel("noLessonGoods"),lessonBads:a.getLabel("lessonBads"),noLessonBads:a.getLabel("noLessonBads"),conclusion:a.getLabel("conclusion"),comments:a.getLabel("comments"),ratings:a.getLabel("ratings"),ratingtHelp:a.getLabel("ratingtHelp"),saveLessonButton:a.getLabel("saveLessonButton"),cancelButton:a.getLabel("cancelButton"),publicLesson:a.getLabel("publicLesson"),buttonAdd:a.getLabel("buttonAdd"),buttonDel:a.getLabel("buttonDel"),requiredField:a.getLabel("requiredField"),showHideHelp:a.getLabel("showHideHelp"),helpTitle:a.getLabel("helpTitle"),helpSpecifics:a.getLabel("helpSpecifics"),helpTags:a.getLabel("helpTags"),helpContent:a.getLabel("helpContent"),helpFeedbacks:a.getLabel("helpFeedbacks"),helpConclusion:a.getLabel("helpConclusion"),addItem:a.getLabel("addItem")},a.model={content:null,tinymceoptions:{plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste image"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"}},a.local={lesson:c,user:b.user,tag:null,lessonGood:null,lessonBad:null,searchedTags:[],editForm:{},isToolBarVisible:function(){return a.local.user.isLogged?a.local.lesson.lessonId?a.local.user.username==a.local.lesson.author.username:!0:!1},isFieldRequired:function(b){return a.local.editForm[b].$invalid&&(a.local.editForm[b].$dirty||a.local.editForm.submitted)},viewHelp:!0},a.actions={filterByActiveStatus:function(a){return"C"!=a.status},getTags:function(a){return d.getTags(a)},getDisciplines:function(a){return d.getDisciplines(a)},getSchools:function(a){return d.getSchools(a)},getClassRooms:function(a){return d.getClassRooms(a)},selectTag:function(){if(null!=a.local.tag&&""!=a.local.tag){for(var b=0;b<a.local.lesson.tags.length;b++)if(a.local.lesson.tags[b]===a.local.tag)return;a.local.lesson.tags.push({lessonId:a.local.lesson.lessonId,content:a.local.tag,status:"A"}),a.local.lesson.tags.status="M",a.local.tag=null}},removeTag:function(b){a.local.lesson.tags[b].status="C"},addGood:function(){if(""!=a.local.lessonGood&&null!=a.local.lessonGood){for(var b=0;b<a.local.lesson.goods.length;b++)if(a.local.lesson.goods[b].content===a.local.lessonGood)return;a.local.lesson.goods.push({id:null,content:a.local.lessonGood,status:"A"}),a.local.lessonGood=null}},editGood:function(b){"I"==a.local.lesson.goods[b].status&&(a.local.lesson.goods[b].status="M")},removeGood:function(b){a.local.lesson.goods[b].status="C"},addBad:function(){if(""!=a.local.lessonBad&&null!=a.local.lessonBad){for(var b=0;b<a.local.lesson.bads.length;b++)if(a.local.lesson.bads[b].content===a.local.lessonBad)return;a.local.lesson.bads.push({id:null,content:a.local.lessonBad,status:"A"}),a.local.lessonBad=null}},editBad:function(b){"I"==a.local.lesson.bads[b].status&&(a.local.lesson.bads[b].status="M")},removeBad:function(b){a.local.lesson.bads[b].status="C"},saveLesson:function(){a.local.editForm.submitted=!0,a.local.editForm.$valid&&(a.local.lesson.author=a.local.user,a.local.lesson.lastModifUser=a.local.user.username,a.local.lesson.lessonId?d.update(a.local.lesson).then(function(a){e.go("lessonDetail",{lessonId:a.lessonId},{inherit:!1})}):(a.local.lesson.lessonId=0,d.create(a.local.lesson).then(function(a){e.go("lessonDetail",{lessonId:a.lessonId},{inherit:!1})})))},cancelEditing:function(){a.local.lesson.lessonId>0?e.go("lessonDetail",{lessonId:c.lessonId},{inherit:!1}):e.go("lessonSearch",{keywod:""},{inherit:!1})},showHideHelp:function(){a.local.viewHelp=!a.local.viewHelp,localStorage.setItem(h.viewHelp,a.local.viewHelp)}},i(),a.$watch(function(){return b.user.isLogged},function(a){a||e.go("lessonSearch",{keyword:""},{inherit:!1})})}]),angular.module("disc.user").factory("UserDTO",function(){function a(){this.userid=null,this.name=null,this.surname=null,this.username=null,this.image=null,this.email=null,this.roles=[],this.isLogged=null}return a}).factory("AuthService",["$http","$q","DiscUtil","DisciturSettings","UserDTO","LabelService",function(a,b,c,d,e,f){var g=function(a){var b=CryptoJS.enc.Utf8.parse(d.criptoKey),c=CryptoJS.enc.Utf8.parse(d.criptoKey),e=CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(a),b,{keySize:16,iv:c,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return String(e)},h=function(a){var b=new e;return b.userid=a.UserId,b.name=a.Name,b.surname=a.Surname,b.username=a.UserName||a.userName,b.image=a.Picture,b.email=a.Email,b.isLogged=!0,b},i=function(){var a=new e;return angular.extend(a,{isLogged:!1}),a},j=function(a){a?localStorage.setItem(d.authToken,a):localStorage.removeItem(d.authToken)},k=function(e){c.validateInput("UserService._loadToken",{username:null,password:null},e);var h={username:e.username,password:g(e.password),grant_type:"password"},i=b.defer();return a.post(d.apiUrl+"Token",$.param(h)).success(function(a){if(a.access_token)j(a.access_token),i.resolve(a);else{var b={code:a.error,description:a.error_description,status:status};i.reject(b)}}).error(function(a){var b=f.apiErrorCode(a.error);i.reject(b)}),i.promise},l=function(a){var b={};return b.UserId=a.userid,b.Name=a.name,b.Surname=a.surname,b.UserName=a.username,b.Email=a.email,b},m={user:angular.extend(new e,{isLogged:!1}),login:function(a){c.validateInput("UserService.login",{username:null,password:null},a);var d=b.defer();return k(a).then(function(){m.getUserInfo().then(function(a){d.resolve(a)},function(a){d.reject(a)})},function(a){d.reject(a)}),d.promise},logout:function(){var a=b.defer();j(null);var c=i();return angular.copy(c,m.user),a.resolve(m.user),a.promise},getUserInfo:function(){var c=b.defer();return a.get(d.apiUrl+"Account/UserInfo").success(function(a){var b=h(a);angular.copy(b,m.user),c.resolve(m.user)}).error(function(a,b){j(null);var d=i();angular.copy(d,m.user);var e={code:b,description:result,status:b};c.reject(e)}),c.promise},signup:function(e){c.validateInput("UserService.signup",{name:null,surname:null,email:null,username:null,password:null},e);var i=b.defer(),j={};return angular.copy(e,j),j.password=g(e.password),a.post(d.apiUrl+"Account/Register",j).success(function(a){var b=h(a);angular.copy(b,m.user),i.resolve(m.user)}).error(function(a){var b=f.apiError(a);i.reject(b)}),i.promise},resolveAuth:function(){var a=b.defer(),c=localStorage.getItem(d.authToken);return c?m.getUserInfo().then(function(b){a.resolve(b)},function(b){a.reject(b)}):a.resolve(m.user),a.promise},retrievePassword:function(e){c.validateInput("UserService.retrievePassword",{username:null},e);var f=b.defer();return a.get(d.apiUrl+"Account/ResetPassword",{params:{UserName:e.username}}).success(function(a){f.resolve(a)}).error(function(a,b){var c={code:a.Message,description:a.ModelState[""][0],status:b};f.reject(c)}),f.promise},changePassword:function(e){c.validateInput("UserService.changePassword",{password:null,newPassword:null,confirmPassword:null},e);var f={OldPassword:g(e.password),NewPassword:g(e.newPassword),ConfirmPassword:g(e.confirmPassword)},h=b.defer();return a.post(d.apiUrl+"Account/ChangePassword",f).success(function(a){h.resolve(a)}).error(function(a,b){var c={code:a.Message,description:a.ModelState[""][0],status:b};h.reject(c)}),h.promise},update:function(f){c.validateInput("UserService.update",new e,f);var g=l(f),i=b.defer();return a.put(d.apiUrl+"User",g).success(function(a){var b=h(a);angular.copy(b,m.user),i.resolve(m.user)}).error(function(a){i.reject("Error updating user id:"+f.id+" -> "+a)}),i.promise},activate:function(e){c.validateInput("UserService.activate",{username:null,key:null},e);var f=b.defer();return a.post(d.apiUrl+"Account/Activate",e).success(function(a){f.resolve(a)}).error(function(a,b){var c={code:a.Message,status:b};f.reject(c)}),f.promise},checkEmail:function(e){c.validateInput("UserService.checkEmail",{email:null},e);var f=b.defer();return a.get(d.apiUrl+"User/anyEmail",{params:e}).success(function(a){f.resolve(!("true"==a))}).error(function(){f.resolve(!1)}),f.promise}},n=localStorage.getItem(d.authToken);return n&&m.getUserInfo(),m}]).factory("UserAuthInterceptor",["$q","DisciturSettings",function(a,b){return{request:function(c){c.headers=c.headers||{};var d=localStorage.getItem(b.authToken);return d&&(c.headers.Authorization="Bearer "+d),c||a.when(c)}}}]),angular.module("disc.user").controller("UserNavBar",["$scope","$state","$modal","AuthService","DisciturBaseCtrl","$injector",function(a,b,c,d,e,f){f.invoke(e,this,{$scope:a}),a._ctrl="UserNavBar";var g;a.labels,a.actions,a.actions={openSignIn:function(a){g=c.open({backdrop:!0,windowClass:"modal-signin",templateUrl:"UserSignIn",controller:"UserSignInCtrl"}),g.result.then(function(){a&&a.ok&&a.ok()},function(){console.log("Modal dismissed at: "+new Date)})},signOff:function(){d.logout()},searchUserLessons:function(){b.go("lessonSearch",{publishedBy:a.model.username},{inherit:!1})},userProfile:function(){b.go("userProfile",null,{inherit:!1})}},a.$on("disc.login",function(b,c){a.actions.openSignIn(c)}),a.labels={userSignIn:a.getLabel("userSignIn"),userSignOff:a.getLabel("userSignOff"),userProfile:a.getLabel("userProfile"),userLessons:a.getLabel("userLessons")},a.model={username:d.user.username,isLogged:d.user.isLogged},a.$watch(function(){return d.user.isLogged},function(){a.model.username=d.user.username,a.model.isLogged=d.user.isLogged})}]),angular.module("disc.user").controller("UserSignInCtrl",["$scope","$modalInstance","AuthService","DisciturBaseCtrl","$injector",function(a,b,c,d,e){e.invoke(d,this,{$scope:a}),a._ctrl="UserSignInCtrl";var f={message:"",init:function(){this.message=""},addMessage:function(a){""!=this.message&&(this.message+="<br>"),this.message+=a}};a.local={username:null,password:null,user:null,SUname:null,SUsurname:null,SUemail:null,SUusername:null,SUpassword:null,SUconfirmpassword:null,errors:{show:!1,message:""},SUerrors:{show:!1,message:""},showForgottedPwd:!1,isCollapsed:!0,usernamePwd:null,errorsPwd:{show:!1,message:""},sentNewPwd:{show:!1,message:""},SUSuccess:{show:!1}},a.labels={username:a.getLabel("username"),password:a.getLabel("password"),forgottenPwdHelp:a.getLabel("forgottenPwdHelp"),sendMail:a.getLabel("sendMail"),signInTitle:a.getLabel("signInTitle"),login:a.getLabel("login"),register:a.getLabel("register"),loginButtom:a.getLabel("loginButtom"),passwordNotValid:a.getLabel("passwordNotValid"),name:a.getLabel("name"),surname:a.getLabel("surname"),email:a.getLabel("email"),confirmPassword:a.getLabel("confirmPassword"),signupButton:a.getLabel("signupButton"),requiredUserName:a.getLabel("requiredUserName"),minLengthUserName:a.getLabel("minLengthUserName"),requiredPassword:a.getLabel("requiredPassword"),minLengthPassword:a.getLabel("minLengthPassword"),requiredName:a.getLabel("requiredName"),requiredSurname:a.getLabel("requiredSurname"),requiredEmail:a.getLabel("requiredEmail"),validEmail:a.getLabel("validEmail"),serverValidationEmail:"Esiste gi\xe0 un account associato a questo indirizzo email",requiredConfirmPassword:a.getLabel("requiredConfirmPassword"),minLengthConfirmPassword:a.getLabel("minLengthConfirmPassword"),matchConfirmPassword:a.getLabel("matchConfirmPassword"),forgottenPassword:a.getLabel("forgottenPassword"),signupSuccess:a.getLabel("signupSuccess")};var g=function(b){a.local.user=b,a.actions.ok()},h=function(b){a.local.errors.message=b.description,a.local.errors.show=!0};a.actions={ok:function(){b.close(0)},cancel:function(){b.dismiss("cancel")},doLogin:function(){a.local.LoginForm.$valid?(a.local.errors.show=!1,c.login({username:a.local.username,password:a.local.password}).then(g,h)):(a.local.LoginForm.username.$invalid&&(a.local.errors.message="",a.local.errors.message+=a.local.LoginForm.username.$error.required?a.labels.requiredUserName:"",a.local.errors.message+=a.local.LoginForm.username.$error.minlength?a.labels.minLengthUserName:"",a.local.errors.show=!0),a.local.LoginForm.password.$invalid&&(a.local.errors.message=a.labels.minLengthPassword,a.local.errors.show=!0))},doLogout:function(){c.logout()},doSignup:function(){a.local.SignupForm.$valid?(a.local.SUerrors.show=!1,c.signup({name:a.local.SUname,surname:a.local.SUsurname,email:a.local.SUemail,username:a.local.SUusername,password:a.local.SUpassword}).then(function(){a.local.SUSuccess.show=!0},function(b){f.init();for(var c=0;c<b.length;c++)f.addMessage(b[c].description);a.local.SUerrors.message=f.message,a.local.SUerrors.show=!0})):(f.init(),a.local.SignupForm.$invalid&&(a.local.SignupForm.name.$error.required&&f.addMessage(a.labels.requiredName),a.local.SignupForm.surname.$error.required&&f.addMessage(a.labels.requiredSurname),a.local.SignupForm.email.$error.required?f.addMessage(a.labels.requiredEmail):a.local.SignupForm.email.$error.email&&f.addMessage(a.labels.validEmail),a.local.SignupForm.username.$error.required?f.addMessage(a.labels.requiredUserName):a.local.SignupForm.username.$error.minlength&&f.addMessage(a.labels.minLengthUserName),a.local.SignupForm.password.$error.required?f.addMessage(a.labels.requiredPassword):a.local.SignupForm.password.$error.minlength&&f.addMessage(a.labels.minLengthPassword),a.local.SignupForm.confirmPassword.$error.required?f.addMessage(a.labels.requiredConfirmPassword):a.local.SignupForm.confirmPassword.$error.minlength?f.addMessage(a.labels.minLengthConfirmPassword):a.local.SignupForm.confirmPassword.$error.pwmatch&&f.addMessage(a.labels.matchConfirmPassword),a.local.SUerrors.message=f.message,a.local.SUerrors.show=!0))},showRetrievePwd:function(){a.local.showForgottedPwd=!a.local.showForgottedPwd},retrievePassword:function(){a.local.errorsPwd.show=!1,a.local.ForgottenPwd.$valid?c.retrievePassword({username:a.local.usernamePwd}).then(function(){a.local.sentNewPwd.message="",a.local.sentNewPwd.message+="A breve riceverai via mail una nuova Password.",a.local.sentNewPwd.show=!0},function(b){a.local.errorsPwd.message="",a.local.errorsPwd.message+=b.description,a.local.errorsPwd.show=!0}):(a.local.errorsPwd.message="",a.local.errorsPwd.message+=a.local.ForgottenPwd.username.$error.required?a.labels.requiredUserName:"",a.local.errorsPwd.message+=a.local.ForgottenPwd.username.$error.minlength?a.labels.minLengthUserName:"",a.local.errorsPwd.show=!0)},checkEmail:function(a){return console.log("Controlla a server il valore:"+a),c.checkEmail({email:a})}}}]),angular.module("disc.user").controller("UserProfileCtrl",["$scope","DisciturBaseCtrl","$injector","user","AuthService","$state",function(a,b,c,d,e,f){c.invoke(b,this,{$scope:a}),a._ctrl="UserProfileCtrl";var g={message:"",init:function(){this.message=""},addMessage:function(a){""!=this.message&&(this.message+="<br>"),this.message+=a}};a.labels={email:a.getLabel("email"),changePassword:a.getLabel("changePassword"),currentPassword:a.getLabel("currentPassword"),newPassword:a.getLabel("newPassword"),confirmPassword:a.getLabel("confirmPassword"),requiredPassword:a.getLabel("requiredPassword"),minLengthPassword:a.getLabel("minLengthPassword"),requiredNewPassword:a.getLabel("requiredNewPassword"),minLengthNewPassword:a.getLabel("minLengthNewPassword"),requiredConfirmPassword:a.getLabel("requiredConfirmPassword"),minLengthConfirmPassword:a.getLabel("minLengthConfirmPassword"),matchConfirmPassword:a.getLabel("matchConfirmPassword"),changedPassword:a.getLabel("changedPassword"),confirm:a.getLabel("confirm"),modify:a.getLabel("modify")},a.local={user:d,viewedUser:{email:d.email},errors:{show:!1,message:""},success:{show:!1,message:""},UpdateUser:{errors:{show:!1,message:""},success:{show:!1,message:""}}},a.actions={changePassword:function(){a.local.ChangePwdForm.$valid?(a.local.errors.show=!1,a.local.success.show=!1,e.changePassword({password:a.local.currentPassword,newPassword:a.local.newPassword,confirmPassword:a.local.confirmPassword}).then(function(){g.init(),a.local.currentPassword="",a.local.newPassword="",a.local.confirmPassword="",a.local.success.message=a.labels.changedPassword,a.local.success.show=!0},function(b){g.init(),g.addMessage(b.description),a.local.errors.message=g.message,a.local.errors.show=!0})):(g.init(),a.local.ChangePwdForm.$invalid&&(a.local.ChangePwdForm.password.$error.required?g.addMessage(a.labels.requiredPassword):a.local.ChangePwdForm.password.$error.minlength&&g.addMessage(a.labels.minLengthPassword),a.local.ChangePwdForm.newPassword.$error.required?g.addMessage(a.labels.requiredNewPassword):a.local.ChangePwdForm.newPassword.$error.minlength&&g.addMessage(a.labels.minLengthNewPassword),a.local.ChangePwdForm.confirmPassword.$error.required?g.addMessage(a.labels.requiredConfirmPassword):a.local.ChangePwdForm.confirmPassword.$error.minlength?g.addMessage(a.labels.minLengthConfirmPassword):a.local.ChangePwdForm.confirmPassword.$error.pwmatch&&g.addMessage(a.labels.matchConfirmPassword),a.local.errors.message=g.message,a.local.errors.show=!0))},updateUser:function(){if(a.local.UpdateUserForm.$valid){var b={};angular.copy(e.user,b),b.email=a.local.viewedUser.email,e.update(b).then(function(){a.local.UpdateUser.success.message="Dati aggiornati con successo.",a.local.UpdateUser.success.show=!0},function(b){a.local.UpdateUser.errors.message=b,a.local.UpdateUser.errors.show=!0})}else alert("NON VALIDO")}},a.$watch(function(){return a.local.user.isLogged},function(a){a||f.go("lessonSearch",{},{inherit:!1})})}]),angular.module("disc.user").controller("UserActivationCtrl",["$scope","DisciturBaseCtrl","$injector","activation","$state",function(a,b,c,d,e){c.invoke(b,this,{$scope:a}),a._ctrl="UserActivationCtrl",a.labels={activationSuccess:a.getLabel("activationSuccess"),activationFailed:a.getLabel("activationFailed")},a.local={activated:d.notActive?!1:!0},a.actions={ok:function(){e.go("lessonSearch",{},{inherit:!1})}}}]),angular.module("discitur",["ui.router","ui.bootstrap","disc.settings","disc.common","disc.lesson","disc.user"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","DisciturSettings",function(a,b,c,d){c.interceptors.push("LoadingInterceptor"),a.state("master",{url:"/","abstract":!0,templateUrl:"masterpages/master.html"}).state("master.1cl",{url:"","abstract":!0,parent:"master",templateUrl:"masterpages/1cl.html"}).state("master.2cl",{url:"","abstract":!0,parent:"master",templateUrl:"masterpages/2cl.html"}),d.isInMaintenance?(b.otherwise("/project/maintenance"),a.state("master.1cl.home",{url:"project/maintenance",parent:"master.1cl",templateUrl:"modules/main/site/Maintenance.html"})):(b.otherwise("/project/home"),a.state("master.1cl.home",{url:"project/home",parent:"master.1cl",templateUrl:"modules/main/site/HomePage.html"}).state("master.1cl.mission",{url:"project/mission",parent:"master.1cl",templateUrl:"modules/main/site/Project.html"}).state("master.1cl.about",{url:"project/About",parent:"master.1cl",templateUrl:"modules/main/site/About.html"}).state("master.1cl.backstage",{url:"project/backstage",parent:"master.1cl",templateUrl:"modules/main/site/BackStage.html"}).state("master.1cl.contribute",{url:"project/contribute",parent:"master.1cl",templateUrl:"modules/main/site/Contribute.html"}))}]).run(["DisciturSettings","$rootScope",function(a,b){b.testEnv=a.testEnv}]),angular.module("discitur").directive("doSignIn",["$rootScope","AuthService",function(a,b){return{restrict:"A",link:function(c,d){d.addClass("pointer"),d.click(function(){b.user.isLogged||a.$broadcast("disc.login",c.actions)})}}}]),angular.module("discitur").factory("DisciturBaseCtrl",[function(){function a(a,b,c){a.absUrl=c.absUrl(),a.absUrlComponent=encodeURIComponent(a.absUrl),a.getLabel=function(c){return b.get(a._ctrl,c)};var d=!1,e=a.$watch(function(){if(d){for(var b=/^{{labels\..*}}/,c=a.$$watchers.length-1;c>=0;c--)a.$$watchers[c].exp&&a.$$watchers[c].exp.exp&&b.test(a.$$watchers[c].exp.exp)&&a.$$watchers.splice(c,1);e()}else d=!0})}return a.$inject=["$scope","LabelService","$location"],a}]),angular.module("discitur").controller("DisciturRootCtrl",["$scope","$rootScope","DisciturBaseCtrl","$injector","AuthService","$state","$urlRouter",function(a,b,c,d,e,f,g){d.invoke(c,this,{$scope:a}),a._ctrl="DisciturMasterCtrl";var h=[function(a){a.preventDefault(),e.resolveAuth()["finally"](function(){g.sync()}),h.splice(0,1)},function(a,b){b.authorized&&!e.user.isLogged&&(a.preventDefault(),f.go("lessonSearch"))}];a.labels={appTitle:a.getLabel("appTitle"),loading:a.getLabel("loading"),testEnv:a.getLabel("testEnv")},b.$on("$stateChangeStart",function(a,b,c,d,e){h[0](a,b,c,d,e)}),b.$on("$stateChangeSuccess",function(){}),b.$on("$stateChangeError",function(a,b,c,d,e,g){return"lessonDetail"===b.name?f.go("404lesson"):g})}]),angular.module("discitur").controller("NavCtrl",["$scope","$rootScope","$location","DisciturBaseCtrl","$injector","DisciturSettings",function(a,b,c,d,e,f){e.invoke(d,this,{$scope:a}),a._ctrl="NavCtrl",a.labels={brand:a.getLabel("brand")},a.local={isInMaintenance:f.isInMaintenance},a.menu=[{id:1,title:"Lezioni",route:"/lesson"},{id:2,title:"Il Progetto",route:"/project",subMenu:[{id:21,title:"Il Manifesto",route:"/project/mission"},{id:22,title:"Chi siamo",route:"/project/About"},{id:23,title:"Contribuisci",route:"/project/contribute"},{id:24,title:"BackStage",route:"/project/backstage"}]}],a.isActiveMenu=function(b){return c.path().indexOf(a.menu[b].route)>=0},a.hasSubMenu=function(b){return void 0!==a.menu[b].subMenu&&a.menu[b].subMenu.length>0}}]);